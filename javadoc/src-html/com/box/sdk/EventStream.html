<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../javadoc.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a name="line.1">package com.box.sdk;</a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span><a name="line.3">import java.util.ArrayList;</a>
<span class="sourceLineNo">004</span><a name="line.4">import java.util.Collection;</a>
<span class="sourceLineNo">005</span><a name="line.5"></a>
<span class="sourceLineNo">006</span><a name="line.6">import com.eclipsesource.json.JsonArray;</a>
<span class="sourceLineNo">007</span><a name="line.7">import com.eclipsesource.json.JsonObject;</a>
<span class="sourceLineNo">008</span><a name="line.8">import com.eclipsesource.json.JsonValue;</a>
<span class="sourceLineNo">009</span><a name="line.9"></a>
<span class="sourceLineNo">010</span><a name="line.10">/**</a>
<span class="sourceLineNo">011</span><a name="line.11"> * Receives real-time events from the API and forwards them to {@link EventListener EventListeners}.</a>
<span class="sourceLineNo">012</span><a name="line.12"> *</a>
<span class="sourceLineNo">013</span><a name="line.13"> * &lt;p&gt;This class handles long polling the Box events endpoint in order to receive real-time user events.</a>
<span class="sourceLineNo">014</span><a name="line.14">  * When an EventStream is started, it begins long polling on a separate thread until the {@link #stop} method</a>
<span class="sourceLineNo">015</span><a name="line.15">  * is called.</a>
<span class="sourceLineNo">016</span><a name="line.16">  * Since the API may return duplicate events, EventStream also maintains a small cache of the most recently received</a>
<span class="sourceLineNo">017</span><a name="line.17">  * event IDs in order to automatically deduplicate events.&lt;/p&gt;</a>
<span class="sourceLineNo">018</span><a name="line.18">  * &lt;p&gt;Note: Enterprise Events can be accessed by admin users with the EventLog.getEnterpriseEvents method&lt;/p&gt;</a>
<span class="sourceLineNo">019</span><a name="line.19"> *</a>
<span class="sourceLineNo">020</span><a name="line.20"> */</a>
<span class="sourceLineNo">021</span><a name="line.21">public class EventStream {</a>
<span class="sourceLineNo">022</span><a name="line.22"></a>
<span class="sourceLineNo">023</span><a name="line.23">    private static final int LIMIT = 800;</a>
<span class="sourceLineNo">024</span><a name="line.24">    private static final int STREAM_POSITION_NOW = -1;</a>
<span class="sourceLineNo">025</span><a name="line.25"></a>
<span class="sourceLineNo">026</span><a name="line.26">    /**</a>
<span class="sourceLineNo">027</span><a name="line.27">     * Events URL.</a>
<span class="sourceLineNo">028</span><a name="line.28">     */</a>
<span class="sourceLineNo">029</span><a name="line.29">    public static final URLTemplate EVENT_URL = new URLTemplate("events?limit=" + LIMIT + "&amp;stream_position=%s");</a>
<span class="sourceLineNo">030</span><a name="line.30"></a>
<span class="sourceLineNo">031</span><a name="line.31">    private final BoxAPIConnection api;</a>
<span class="sourceLineNo">032</span><a name="line.32">    private final long startingPosition;</a>
<span class="sourceLineNo">033</span><a name="line.33">    private final Collection&lt;EventListener&gt; listeners;</a>
<span class="sourceLineNo">034</span><a name="line.34">    private final Object listenerLock;</a>
<span class="sourceLineNo">035</span><a name="line.35"></a>
<span class="sourceLineNo">036</span><a name="line.36">    private LRUCache&lt;String&gt; receivedEvents;</a>
<span class="sourceLineNo">037</span><a name="line.37">    private boolean started;</a>
<span class="sourceLineNo">038</span><a name="line.38">    private Poller poller;</a>
<span class="sourceLineNo">039</span><a name="line.39">    private Thread pollerThread;</a>
<span class="sourceLineNo">040</span><a name="line.40"></a>
<span class="sourceLineNo">041</span><a name="line.41">    /**</a>
<span class="sourceLineNo">042</span><a name="line.42">     * Constructs an EventStream using an API connection.</a>
<span class="sourceLineNo">043</span><a name="line.43">     * @param  api the API connection to use.</a>
<span class="sourceLineNo">044</span><a name="line.44">     */</a>
<span class="sourceLineNo">045</span><a name="line.45">    public EventStream(BoxAPIConnection api) {</a>
<span class="sourceLineNo">046</span><a name="line.46">        this(api, STREAM_POSITION_NOW);</a>
<span class="sourceLineNo">047</span><a name="line.47">    }</a>
<span class="sourceLineNo">048</span><a name="line.48"></a>
<span class="sourceLineNo">049</span><a name="line.49">    /**</a>
<span class="sourceLineNo">050</span><a name="line.50">     * Constructs an EventStream using an API connection and a starting initial position.</a>
<span class="sourceLineNo">051</span><a name="line.51">     * @param api the API connection to use.</a>
<span class="sourceLineNo">052</span><a name="line.52">     * @param startingPosition the starting position of the event stream.</a>
<span class="sourceLineNo">053</span><a name="line.53">     */</a>
<span class="sourceLineNo">054</span><a name="line.54">    public EventStream(BoxAPIConnection api, long startingPosition) {</a>
<span class="sourceLineNo">055</span><a name="line.55">        this.api = api;</a>
<span class="sourceLineNo">056</span><a name="line.56">        this.startingPosition = startingPosition;</a>
<span class="sourceLineNo">057</span><a name="line.57">        this.listeners = new ArrayList&lt;EventListener&gt;();</a>
<span class="sourceLineNo">058</span><a name="line.58">        this.listenerLock = new Object();</a>
<span class="sourceLineNo">059</span><a name="line.59">    }</a>
<span class="sourceLineNo">060</span><a name="line.60"></a>
<span class="sourceLineNo">061</span><a name="line.61">    /**</a>
<span class="sourceLineNo">062</span><a name="line.62">     * Adds a listener that will be notified when an event is received.</a>
<span class="sourceLineNo">063</span><a name="line.63">     * @param listener the listener to add.</a>
<span class="sourceLineNo">064</span><a name="line.64">     */</a>
<span class="sourceLineNo">065</span><a name="line.65">    public void addListener(EventListener listener) {</a>
<span class="sourceLineNo">066</span><a name="line.66">        synchronized (this.listenerLock) {</a>
<span class="sourceLineNo">067</span><a name="line.67">            this.listeners.add(listener);</a>
<span class="sourceLineNo">068</span><a name="line.68">        }</a>
<span class="sourceLineNo">069</span><a name="line.69">    }</a>
<span class="sourceLineNo">070</span><a name="line.70"></a>
<span class="sourceLineNo">071</span><a name="line.71">    /**</a>
<span class="sourceLineNo">072</span><a name="line.72">     * Indicates whether or not this EventStream has been started.</a>
<span class="sourceLineNo">073</span><a name="line.73">     * @return true if this EventStream has been started; otherwise false.</a>
<span class="sourceLineNo">074</span><a name="line.74">     */</a>
<span class="sourceLineNo">075</span><a name="line.75">    public boolean isStarted() {</a>
<span class="sourceLineNo">076</span><a name="line.76">        return this.started;</a>
<span class="sourceLineNo">077</span><a name="line.77">    }</a>
<span class="sourceLineNo">078</span><a name="line.78"></a>
<span class="sourceLineNo">079</span><a name="line.79">    /**</a>
<span class="sourceLineNo">080</span><a name="line.80">     * Stops this EventStream and disconnects from the API.</a>
<span class="sourceLineNo">081</span><a name="line.81">     * @throws IllegalStateException if the EventStream is already stopped.</a>
<span class="sourceLineNo">082</span><a name="line.82">     */</a>
<span class="sourceLineNo">083</span><a name="line.83">    public void stop() {</a>
<span class="sourceLineNo">084</span><a name="line.84">        if (!this.started) {</a>
<span class="sourceLineNo">085</span><a name="line.85">            throw new IllegalStateException("Cannot stop the EventStream because it isn't started.");</a>
<span class="sourceLineNo">086</span><a name="line.86">        }</a>
<span class="sourceLineNo">087</span><a name="line.87"></a>
<span class="sourceLineNo">088</span><a name="line.88">        this.started = false;</a>
<span class="sourceLineNo">089</span><a name="line.89">        this.pollerThread.interrupt();</a>
<span class="sourceLineNo">090</span><a name="line.90">    }</a>
<span class="sourceLineNo">091</span><a name="line.91"></a>
<span class="sourceLineNo">092</span><a name="line.92">    /**</a>
<span class="sourceLineNo">093</span><a name="line.93">     * Starts this EventStream and begins long polling the API.</a>
<span class="sourceLineNo">094</span><a name="line.94">     * @throws IllegalStateException if the EventStream is already started.</a>
<span class="sourceLineNo">095</span><a name="line.95">     */</a>
<span class="sourceLineNo">096</span><a name="line.96">    public void start() {</a>
<span class="sourceLineNo">097</span><a name="line.97">        if (this.started) {</a>
<span class="sourceLineNo">098</span><a name="line.98">            throw new IllegalStateException("Cannot start the EventStream because it isn't stopped.");</a>
<span class="sourceLineNo">099</span><a name="line.99">        }</a>
<span class="sourceLineNo">100</span><a name="line.100"></a>
<span class="sourceLineNo">101</span><a name="line.101">        final long initialPosition;</a>
<span class="sourceLineNo">102</span><a name="line.102"></a>
<span class="sourceLineNo">103</span><a name="line.103">        if (this.startingPosition == STREAM_POSITION_NOW) {</a>
<span class="sourceLineNo">104</span><a name="line.104">            BoxAPIRequest request = new BoxAPIRequest(this.api, EVENT_URL.build(this.api.getBaseURL(), "now"), "GET");</a>
<span class="sourceLineNo">105</span><a name="line.105">            BoxJSONResponse response = (BoxJSONResponse) request.send();</a>
<span class="sourceLineNo">106</span><a name="line.106">            JsonObject jsonObject = JsonObject.readFrom(response.getJSON());</a>
<span class="sourceLineNo">107</span><a name="line.107">            initialPosition = jsonObject.get("next_stream_position").asLong();</a>
<span class="sourceLineNo">108</span><a name="line.108">        } else {</a>
<span class="sourceLineNo">109</span><a name="line.109">            initialPosition = this.startingPosition;</a>
<span class="sourceLineNo">110</span><a name="line.110">        }</a>
<span class="sourceLineNo">111</span><a name="line.111"></a>
<span class="sourceLineNo">112</span><a name="line.112">        this.poller = new Poller(initialPosition);</a>
<span class="sourceLineNo">113</span><a name="line.113"></a>
<span class="sourceLineNo">114</span><a name="line.114">        this.pollerThread = new Thread(this.poller);</a>
<span class="sourceLineNo">115</span><a name="line.115">        this.pollerThread.setUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {</a>
<span class="sourceLineNo">116</span><a name="line.116">            public void uncaughtException(Thread t, Throwable e) {</a>
<span class="sourceLineNo">117</span><a name="line.117">                EventStream.this.notifyException(e);</a>
<span class="sourceLineNo">118</span><a name="line.118">            }</a>
<span class="sourceLineNo">119</span><a name="line.119">        });</a>
<span class="sourceLineNo">120</span><a name="line.120">        this.pollerThread.start();</a>
<span class="sourceLineNo">121</span><a name="line.121"></a>
<span class="sourceLineNo">122</span><a name="line.122">        this.started = true;</a>
<span class="sourceLineNo">123</span><a name="line.123">    }</a>
<span class="sourceLineNo">124</span><a name="line.124"></a>
<span class="sourceLineNo">125</span><a name="line.125">    /**</a>
<span class="sourceLineNo">126</span><a name="line.126">     * Indicates whether or not an event ID is a duplicate.</a>
<span class="sourceLineNo">127</span><a name="line.127">     *</a>
<span class="sourceLineNo">128</span><a name="line.128">     * &lt;p&gt;This method can be overridden by a subclass in order to provide custom de-duping logic.&lt;/p&gt;</a>
<span class="sourceLineNo">129</span><a name="line.129">     *</a>
<span class="sourceLineNo">130</span><a name="line.130">     * @param  eventID the event ID.</a>
<span class="sourceLineNo">131</span><a name="line.131">     * @return         true if the event is a duplicate; otherwise false.</a>
<span class="sourceLineNo">132</span><a name="line.132">     */</a>
<span class="sourceLineNo">133</span><a name="line.133">    protected boolean isDuplicate(String eventID) {</a>
<span class="sourceLineNo">134</span><a name="line.134">        if (this.receivedEvents == null) {</a>
<span class="sourceLineNo">135</span><a name="line.135">            this.receivedEvents = new LRUCache&lt;String&gt;();</a>
<span class="sourceLineNo">136</span><a name="line.136">        }</a>
<span class="sourceLineNo">137</span><a name="line.137"></a>
<span class="sourceLineNo">138</span><a name="line.138">        return !this.receivedEvents.add(eventID);</a>
<span class="sourceLineNo">139</span><a name="line.139">    }</a>
<span class="sourceLineNo">140</span><a name="line.140"></a>
<span class="sourceLineNo">141</span><a name="line.141">    private void notifyNextPosition(long position) {</a>
<span class="sourceLineNo">142</span><a name="line.142">        synchronized (this.listenerLock) {</a>
<span class="sourceLineNo">143</span><a name="line.143">            for (EventListener listener : this.listeners) {</a>
<span class="sourceLineNo">144</span><a name="line.144">                listener.onNextPosition(position);</a>
<span class="sourceLineNo">145</span><a name="line.145">            }</a>
<span class="sourceLineNo">146</span><a name="line.146">        }</a>
<span class="sourceLineNo">147</span><a name="line.147">    }</a>
<span class="sourceLineNo">148</span><a name="line.148"></a>
<span class="sourceLineNo">149</span><a name="line.149">    private void notifyEvent(BoxEvent event) {</a>
<span class="sourceLineNo">150</span><a name="line.150">        synchronized (this.listenerLock) {</a>
<span class="sourceLineNo">151</span><a name="line.151">            boolean isDuplicate = this.isDuplicate(event.getID());</a>
<span class="sourceLineNo">152</span><a name="line.152">            if (!isDuplicate) {</a>
<span class="sourceLineNo">153</span><a name="line.153">                for (EventListener listener : this.listeners) {</a>
<span class="sourceLineNo">154</span><a name="line.154">                    listener.onEvent(event);</a>
<span class="sourceLineNo">155</span><a name="line.155">                }</a>
<span class="sourceLineNo">156</span><a name="line.156">            }</a>
<span class="sourceLineNo">157</span><a name="line.157">        }</a>
<span class="sourceLineNo">158</span><a name="line.158">    }</a>
<span class="sourceLineNo">159</span><a name="line.159"></a>
<span class="sourceLineNo">160</span><a name="line.160">    private void notifyException(Throwable e) {</a>
<span class="sourceLineNo">161</span><a name="line.161">        if (e instanceof InterruptedException &amp;&amp; !this.started) {</a>
<span class="sourceLineNo">162</span><a name="line.162">            return;</a>
<span class="sourceLineNo">163</span><a name="line.163">        }</a>
<span class="sourceLineNo">164</span><a name="line.164"></a>
<span class="sourceLineNo">165</span><a name="line.165">        this.stop();</a>
<span class="sourceLineNo">166</span><a name="line.166">        synchronized (this.listenerLock) {</a>
<span class="sourceLineNo">167</span><a name="line.167">            for (EventListener listener : this.listeners) {</a>
<span class="sourceLineNo">168</span><a name="line.168">                if (listener.onException(e)) {</a>
<span class="sourceLineNo">169</span><a name="line.169">                    return;</a>
<span class="sourceLineNo">170</span><a name="line.170">                }</a>
<span class="sourceLineNo">171</span><a name="line.171">            }</a>
<span class="sourceLineNo">172</span><a name="line.172">        }</a>
<span class="sourceLineNo">173</span><a name="line.173">    }</a>
<span class="sourceLineNo">174</span><a name="line.174"></a>
<span class="sourceLineNo">175</span><a name="line.175">    private class Poller implements Runnable {</a>
<span class="sourceLineNo">176</span><a name="line.176">        private final long initialPosition;</a>
<span class="sourceLineNo">177</span><a name="line.177"></a>
<span class="sourceLineNo">178</span><a name="line.178">        private RealtimeServerConnection server;</a>
<span class="sourceLineNo">179</span><a name="line.179"></a>
<span class="sourceLineNo">180</span><a name="line.180">        public Poller(long initialPosition) {</a>
<span class="sourceLineNo">181</span><a name="line.181">            this.initialPosition = initialPosition;</a>
<span class="sourceLineNo">182</span><a name="line.182">            this.server = new RealtimeServerConnection(EventStream.this.api);</a>
<span class="sourceLineNo">183</span><a name="line.183">        }</a>
<span class="sourceLineNo">184</span><a name="line.184"></a>
<span class="sourceLineNo">185</span><a name="line.185">        @Override</a>
<span class="sourceLineNo">186</span><a name="line.186">        public void run() {</a>
<span class="sourceLineNo">187</span><a name="line.187">            long position = this.initialPosition;</a>
<span class="sourceLineNo">188</span><a name="line.188">            while (!Thread.interrupted()) {</a>
<span class="sourceLineNo">189</span><a name="line.189">                if (this.server.getRemainingRetries() == 0) {</a>
<span class="sourceLineNo">190</span><a name="line.190">                    this.server = new RealtimeServerConnection(EventStream.this.api);</a>
<span class="sourceLineNo">191</span><a name="line.191">                }</a>
<span class="sourceLineNo">192</span><a name="line.192"></a>
<span class="sourceLineNo">193</span><a name="line.193">                if (this.server.waitForChange(position)) {</a>
<span class="sourceLineNo">194</span><a name="line.194">                    if (Thread.interrupted()) {</a>
<span class="sourceLineNo">195</span><a name="line.195">                        return;</a>
<span class="sourceLineNo">196</span><a name="line.196">                    }</a>
<span class="sourceLineNo">197</span><a name="line.197"></a>
<span class="sourceLineNo">198</span><a name="line.198">                    BoxAPIRequest request = new BoxAPIRequest(EventStream.this.api,</a>
<span class="sourceLineNo">199</span><a name="line.199">                        EVENT_URL.build(EventStream.this.api.getBaseURL(), position), "GET");</a>
<span class="sourceLineNo">200</span><a name="line.200">                    BoxJSONResponse response = (BoxJSONResponse) request.send();</a>
<span class="sourceLineNo">201</span><a name="line.201">                    JsonObject jsonObject = JsonObject.readFrom(response.getJSON());</a>
<span class="sourceLineNo">202</span><a name="line.202">                    JsonArray entriesArray = jsonObject.get("entries").asArray();</a>
<span class="sourceLineNo">203</span><a name="line.203">                    for (JsonValue entry : entriesArray) {</a>
<span class="sourceLineNo">204</span><a name="line.204">                        BoxEvent event = new BoxEvent(EventStream.this.api, entry.asObject());</a>
<span class="sourceLineNo">205</span><a name="line.205">                        EventStream.this.notifyEvent(event);</a>
<span class="sourceLineNo">206</span><a name="line.206">                    }</a>
<span class="sourceLineNo">207</span><a name="line.207">                    position = jsonObject.get("next_stream_position").asLong();</a>
<span class="sourceLineNo">208</span><a name="line.208">                    EventStream.this.notifyNextPosition(position);</a>
<span class="sourceLineNo">209</span><a name="line.209">                }</a>
<span class="sourceLineNo">210</span><a name="line.210">            }</a>
<span class="sourceLineNo">211</span><a name="line.211">        }</a>
<span class="sourceLineNo">212</span><a name="line.212">    }</a>
<span class="sourceLineNo">213</span><a name="line.213">}</a>




























































</pre>
</div>
</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../javadoc.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a name="line.1">package com.box.sdk;</a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span><a name="line.3">import java.util.ArrayList;</a>
<span class="sourceLineNo">004</span><a name="line.4">import java.util.HashMap;</a>
<span class="sourceLineNo">005</span><a name="line.5">import java.util.Iterator;</a>
<span class="sourceLineNo">006</span><a name="line.6">import java.util.List;</a>
<span class="sourceLineNo">007</span><a name="line.7">import java.util.Map;</a>
<span class="sourceLineNo">008</span><a name="line.8"></a>
<span class="sourceLineNo">009</span><a name="line.9">import com.box.sdk.http.HttpHeaders;</a>
<span class="sourceLineNo">010</span><a name="line.10">import com.box.sdk.http.HttpMethod;</a>
<span class="sourceLineNo">011</span><a name="line.11">import com.eclipsesource.json.JsonArray;</a>
<span class="sourceLineNo">012</span><a name="line.12">import com.eclipsesource.json.JsonObject;</a>
<span class="sourceLineNo">013</span><a name="line.13">import com.eclipsesource.json.JsonValue;</a>
<span class="sourceLineNo">014</span><a name="line.14"></a>
<span class="sourceLineNo">015</span><a name="line.15">/**</a>
<span class="sourceLineNo">016</span><a name="line.16"> * Used to make a bunch of HTTP Requests as a batch. Currently the number of requests that can be batched at once</a>
<span class="sourceLineNo">017</span><a name="line.17"> * is capped at &lt;b&gt;20&lt;/b&gt; by the API layer. Also there are certain requests which &lt;b&gt;cannot&lt;/b&gt; be performed</a>
<span class="sourceLineNo">018</span><a name="line.18"> * by Batch API. Check API documentation for more information.</a>
<span class="sourceLineNo">019</span><a name="line.19"> *</a>
<span class="sourceLineNo">020</span><a name="line.20"> * &lt;p&gt;The request itself is a BoxJSONRequest but extends it to provide additional functionality for aggregating</a>
<span class="sourceLineNo">021</span><a name="line.21"> *  a bunch of requests and responding with multiple responses as if the requests were called individually&lt;/p&gt;</a>
<span class="sourceLineNo">022</span><a name="line.22"> */</a>
<span class="sourceLineNo">023</span><a name="line.23">public class BatchAPIRequest extends BoxJSONRequest {</a>
<span class="sourceLineNo">024</span><a name="line.24">    /**</a>
<span class="sourceLineNo">025</span><a name="line.25">     * Batch URL Template.</a>
<span class="sourceLineNo">026</span><a name="line.26">     */</a>
<span class="sourceLineNo">027</span><a name="line.27">    public static final URLTemplate BATCH_URL_TEMPLATE = new URLTemplate("batch");</a>
<span class="sourceLineNo">028</span><a name="line.28">    private final BoxAPIConnection api;</a>
<span class="sourceLineNo">029</span><a name="line.29"></a>
<span class="sourceLineNo">030</span><a name="line.30">    /**</a>
<span class="sourceLineNo">031</span><a name="line.31">     * Constructs an authenticated BatchRequest using a provided BoxAPIConnection.</a>
<span class="sourceLineNo">032</span><a name="line.32">     * @param  api    an API connection for authenticating the request.</a>
<span class="sourceLineNo">033</span><a name="line.33">     */</a>
<span class="sourceLineNo">034</span><a name="line.34">    public BatchAPIRequest(BoxAPIConnection api) {</a>
<span class="sourceLineNo">035</span><a name="line.35">        super(api, BATCH_URL_TEMPLATE.build(api.getBaseURL()), HttpMethod.GET);</a>
<span class="sourceLineNo">036</span><a name="line.36">        this.api = api;</a>
<span class="sourceLineNo">037</span><a name="line.37">    }</a>
<span class="sourceLineNo">038</span><a name="line.38"></a>
<span class="sourceLineNo">039</span><a name="line.39">    /**</a>
<span class="sourceLineNo">040</span><a name="line.40">     * Execute a set of API calls as batch request.</a>
<span class="sourceLineNo">041</span><a name="line.41">     * @param requests list of api requests that has to be executed in batch.</a>
<span class="sourceLineNo">042</span><a name="line.42">     * @return list of BoxAPIResponses</a>
<span class="sourceLineNo">043</span><a name="line.43">     */</a>
<span class="sourceLineNo">044</span><a name="line.44">    public List&lt;BoxAPIResponse&gt; execute(List&lt;BoxAPIRequest&gt; requests) {</a>
<span class="sourceLineNo">045</span><a name="line.45">        this.prepareRequest(requests);</a>
<span class="sourceLineNo">046</span><a name="line.46">        BoxJSONResponse batchResponse = (BoxJSONResponse) send();</a>
<span class="sourceLineNo">047</span><a name="line.47">        return this.parseResponse(batchResponse);</a>
<span class="sourceLineNo">048</span><a name="line.48">    }</a>
<span class="sourceLineNo">049</span><a name="line.49"></a>
<span class="sourceLineNo">050</span><a name="line.50">    /**</a>
<span class="sourceLineNo">051</span><a name="line.51">     * Prepare a batch api request using list of individual reuests.</a>
<span class="sourceLineNo">052</span><a name="line.52">     * @param requests list of api requests that has to be executed in batch.</a>
<span class="sourceLineNo">053</span><a name="line.53">     */</a>
<span class="sourceLineNo">054</span><a name="line.54">    protected void prepareRequest(List&lt;BoxAPIRequest&gt; requests) {</a>
<span class="sourceLineNo">055</span><a name="line.55">        JsonObject body = new JsonObject();</a>
<span class="sourceLineNo">056</span><a name="line.56">        JsonArray requestsJSONArray = new JsonArray();</a>
<span class="sourceLineNo">057</span><a name="line.57">        for (BoxAPIRequest request: requests) {</a>
<span class="sourceLineNo">058</span><a name="line.58">            JsonObject batchRequest = new JsonObject();</a>
<span class="sourceLineNo">059</span><a name="line.59">            batchRequest.add("method", request.getMethod());</a>
<span class="sourceLineNo">060</span><a name="line.60">            batchRequest.add("relative_url", request.getUrl().toString().substring(this.api.getBaseURL().length() - 1));</a>
<span class="sourceLineNo">061</span><a name="line.61">            //If the actual request has a JSON body then add it to vatch request</a>
<span class="sourceLineNo">062</span><a name="line.62">            if (request instanceof BoxJSONRequest) {</a>
<span class="sourceLineNo">063</span><a name="line.63">                BoxJSONRequest jsonRequest = (BoxJSONRequest) request;</a>
<span class="sourceLineNo">064</span><a name="line.64">                batchRequest.add("body", jsonRequest.getBodyAsJsonObject());</a>
<span class="sourceLineNo">065</span><a name="line.65">            }</a>
<span class="sourceLineNo">066</span><a name="line.66">            //Add any headers that are in the request, except Authorization</a>
<span class="sourceLineNo">067</span><a name="line.67">            if (request.getHeaders() != null) {</a>
<span class="sourceLineNo">068</span><a name="line.68">                JsonObject batchRequestHeaders = new JsonObject();</a>
<span class="sourceLineNo">069</span><a name="line.69">                for (RequestHeader header: request.getHeaders()) {</a>
<span class="sourceLineNo">070</span><a name="line.70">                    if (header.getKey() != null &amp;&amp; !header.getKey().isEmpty()</a>
<span class="sourceLineNo">071</span><a name="line.71">                        &amp;&amp; HttpHeaders.AUTHORIZATION.equals(header.getKey())) {</a>
<span class="sourceLineNo">072</span><a name="line.72">                        batchRequestHeaders.add(header.getKey(), header.getValue());</a>
<span class="sourceLineNo">073</span><a name="line.73">                    }</a>
<span class="sourceLineNo">074</span><a name="line.74">                }</a>
<span class="sourceLineNo">075</span><a name="line.75">                batchRequest.add("headers", batchRequestHeaders);</a>
<span class="sourceLineNo">076</span><a name="line.76">            }</a>
<span class="sourceLineNo">077</span><a name="line.77"></a>
<span class="sourceLineNo">078</span><a name="line.78">            //Add the request to array</a>
<span class="sourceLineNo">079</span><a name="line.79">            requestsJSONArray.add(batchRequest);</a>
<span class="sourceLineNo">080</span><a name="line.80">        }</a>
<span class="sourceLineNo">081</span><a name="line.81">        //Add the requests array to body</a>
<span class="sourceLineNo">082</span><a name="line.82">        body.add("requests", requestsJSONArray);</a>
<span class="sourceLineNo">083</span><a name="line.83">        super.setBody(body);</a>
<span class="sourceLineNo">084</span><a name="line.84">    }</a>
<span class="sourceLineNo">085</span><a name="line.85"></a>
<span class="sourceLineNo">086</span><a name="line.86">    /**</a>
<span class="sourceLineNo">087</span><a name="line.87">     * Parses btch api response to create a list of BoxAPIResponse objects.</a>
<span class="sourceLineNo">088</span><a name="line.88">     * @param batchResponse response of a batch api request</a>
<span class="sourceLineNo">089</span><a name="line.89">     * @return list of BoxAPIResponses</a>
<span class="sourceLineNo">090</span><a name="line.90">     */</a>
<span class="sourceLineNo">091</span><a name="line.91">    protected List&lt;BoxAPIResponse&gt; parseResponse(BoxJSONResponse batchResponse) {</a>
<span class="sourceLineNo">092</span><a name="line.92">        JsonObject responseJSON = JsonObject.readFrom(batchResponse.getJSON());</a>
<span class="sourceLineNo">093</span><a name="line.93">        List&lt;BoxAPIResponse&gt; responses = new ArrayList&lt;BoxAPIResponse&gt;();</a>
<span class="sourceLineNo">094</span><a name="line.94">        Iterator&lt;JsonValue&gt; responseIterator = responseJSON.get("responses").asArray().iterator();</a>
<span class="sourceLineNo">095</span><a name="line.95">        while (responseIterator.hasNext()) {</a>
<span class="sourceLineNo">096</span><a name="line.96">            JsonObject jsonResponse = responseIterator.next().asObject();</a>
<span class="sourceLineNo">097</span><a name="line.97">            BoxAPIResponse response = null;</a>
<span class="sourceLineNo">098</span><a name="line.98"></a>
<span class="sourceLineNo">099</span><a name="line.99">            //Gather headers</a>
<span class="sourceLineNo">100</span><a name="line.100">            Map&lt;String, String&gt; responseHeaders = new HashMap&lt;String, String&gt;();</a>
<span class="sourceLineNo">101</span><a name="line.101"></a>
<span class="sourceLineNo">102</span><a name="line.102">            if (jsonResponse.get("headers") != null) {</a>
<span class="sourceLineNo">103</span><a name="line.103">                JsonObject batchResponseHeadersObject = jsonResponse.get("headers").asObject();</a>
<span class="sourceLineNo">104</span><a name="line.104">                for (JsonObject.Member member : batchResponseHeadersObject) {</a>
<span class="sourceLineNo">105</span><a name="line.105">                    String headerName = member.getName();</a>
<span class="sourceLineNo">106</span><a name="line.106">                    String headerValue = member.getValue().asString();</a>
<span class="sourceLineNo">107</span><a name="line.107">                    responseHeaders.put(headerName, headerValue);</a>
<span class="sourceLineNo">108</span><a name="line.108">                }</a>
<span class="sourceLineNo">109</span><a name="line.109">            }</a>
<span class="sourceLineNo">110</span><a name="line.110"></a>
<span class="sourceLineNo">111</span><a name="line.111">            // Construct a BoxAPIResponse when response is null, or a BoxJSONResponse when there's a response</a>
<span class="sourceLineNo">112</span><a name="line.112">            // (not anticipating any other response as per current APIs.</a>
<span class="sourceLineNo">113</span><a name="line.113">            // Ideally we should do it based on response header)</a>
<span class="sourceLineNo">114</span><a name="line.114">            if (jsonResponse.get("response") == null || jsonResponse.get("response").isNull()) {</a>
<span class="sourceLineNo">115</span><a name="line.115">                response =</a>
<span class="sourceLineNo">116</span><a name="line.116">                    new BoxAPIResponse(jsonResponse.get("status").asInt(), responseHeaders);</a>
<span class="sourceLineNo">117</span><a name="line.117">            } else {</a>
<span class="sourceLineNo">118</span><a name="line.118">                response =</a>
<span class="sourceLineNo">119</span><a name="line.119">                    new BoxJSONResponse(jsonResponse.get("status").asInt(), responseHeaders,</a>
<span class="sourceLineNo">120</span><a name="line.120">                        jsonResponse.get("response").asObject());</a>
<span class="sourceLineNo">121</span><a name="line.121">            }</a>
<span class="sourceLineNo">122</span><a name="line.122">            responses.add(response);</a>
<span class="sourceLineNo">123</span><a name="line.123">        }</a>
<span class="sourceLineNo">124</span><a name="line.124">        return responses;</a>
<span class="sourceLineNo">125</span><a name="line.125">    }</a>
<span class="sourceLineNo">126</span><a name="line.126">}</a>




























































</pre>
</div>
</body>
</html>
